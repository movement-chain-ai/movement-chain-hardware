name: Hardware PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  validate-hardware:
    runs-on: ubuntu-latest
    container:
      image: setsoft/kicad_auto:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List KiCad files
        run: |
          echo "## Hardware Files ðŸ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh *.kicad_* 2>/dev/null || echo "No KiCad files found"
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Run ERC
        run: |
          for sch in *.kicad_sch; do
            if [ -f "$sch" ]; then
              echo "Running ERC on $sch..."
              kicad-cli sch erc "$sch" || echo "âš ï¸  ERC warnings"
            fi
          done
        continue-on-error: true

      - name: Run DRC
        run: |
          for pcb in *.kicad_pcb; do
            if [ -f "$pcb" ]; then
              echo "Running DRC on $pcb..."
              kicad-cli pcb drc "$pcb" || echo "âš ï¸  DRC warnings"
            fi
          done
        continue-on-error: true

      - name: Export Gerbers
        run: |
          for pcb in *.kicad_pcb; do
            if [ -f "$pcb" ]; then
              echo "Exporting Gerbers for $pcb..."
              mkdir -p gerbers
              kicad-cli pcb export gerbers --output gerbers/ "$pcb" || true
            fi
          done
        continue-on-error: true

      - name: Export BOM
        run: |
          for sch in *.kicad_sch; do
            if [ -f "$sch" ]; then
              echo "Exporting BOM for $sch..."
              kicad-cli sch export bom --output BOM.csv "$sch" || true
            fi
          done
        continue-on-error: true

      - name: Upload Gerbers
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gerbers-pr${{ github.event.pull_request.number }}
          path: gerbers/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload BOM
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bom-pr${{ github.event.pull_request.number }}
          path: BOM.csv
          retention-days: 7
          if-no-files-found: ignore

      - name: Create summary
        if: always()
        run: |
          echo "## Hardware Validation Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ERC: Checked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DRC: Checked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gerbers: Exported" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… BOM: Generated" >> $GITHUB_STEP_SUMMARY
